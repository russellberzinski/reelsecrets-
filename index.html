<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ReelSecrets • What They Don’t Post on YouTube</title>
  <meta name="description" content="Free sneak peeks. Premium unlocks: full videos + real details serious anglers want." />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a33; --text:#e8edf7; --muted:#b7c0d6;
      --line:#223152; --accent:#14b8a6; --accent2:#60a5fa; --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:grid;place-items:center;font-weight:800}
    .brand h1{font-size:18px;margin:0;line-height:1}
    .brand small{color:var(--muted)}
    .pill{border:1px solid var(--line);padding:8px 12px;border-radius:999px;color:var(--muted);background:rgba(255,255,255,.02)}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,rgba(96,165,250,.25),rgba(20,184,166,.25));border-color:rgba(96,165,250,.35)}
    .btn.danger{border-color:rgba(239,68,68,.35);color:#ffd5d5}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hero{padding:22px;margin-bottom:16px}
    .hero h2{margin:0 0 8px;font-size:34px;line-height:1.05}
    .hero p{margin:0;color:var(--muted);max-width:860px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:960px){.grid{grid-template-columns:420px 1fr}}
    .panel{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.2);color:var(--text)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .posts{display:grid;gap:12px}
    .post{padding:14px}
    .postTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
    .post h3{margin:0 0 6px;font-size:18px}
    .meta{font-size:12px;color:var(--muted)}
    .video{margin-top:10px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#000}
    .video iframe{width:100%;height:230px;border:0;display:block}
    .actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .price{color:#d7ffe9;border:1px solid rgba(20,184,166,.35);background:rgba(20,184,166,.08);padding:6px 10px;border-radius:999px;font-size:12px}
    .status{font-size:12px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .toast{margin-top:10px;font-size:13px}
    .ok{color:#b7ffea}
    .bad{color:#ffb7b7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">RS</div>
        <div>
          <h1>ReelSecrets</h1>
          <small>What They Don’t Post on YouTube</small>
        </div>
      </div>

      <div class="row">
        <span id="firebaseStatus" class="pill">Connecting…</span>
        <button id="loginBtn" class="btn">Log in</button>
        <button id="logoutBtn" class="btn danger" style="display:none;">Log out</button>
      </div>
    </div>

    <div class="card hero">
      <h2>Free sneak peeks.<br/>Premium is where the real details live.</h2>
      <p>Creators post a short preview for free. Viewers unlock the full video + the “off-YouTube” breakdown with a purchase.</p>
      <div class="divider"></div>
      <div class="row">
        <span class="pill">Preview → Premium</span>
        <span class="pill">Pay per video</span>
        <span class="pill">Creator-first pricing</span>
      </div>
    </div>

    <div class="grid">
      <!-- Creator panel -->
      <div class="card panel">
        <h3 style="margin:0 0 6px;">Creator posting</h3>
        <div class="small">Testing mode: paste links (no Firebase Storage needed).</div>

        <div id="authHint" class="toast bad" style="display:none;margin-top:10px;">
          Please log in to post.
        </div>

        <form id="postForm" style="margin-top:8px;">
          <label>Title</label>
          <input id="title" placeholder="Ex: Winter Smallmouth Pattern Breakdown" required maxlength="90" />

          <label>State</label>
          <select id="state" required>
            <option value="">Select state…</option>
            <option>Wisconsin</option><option>Minnesota</option><option>Michigan</option><option>Illinois</option>
            <option>Iowa</option><option>Indiana</option><option>Ohio</option><option>Missouri</option>
            <option>Texas</option><option>Florida</option><option>California</option><option>New York</option>
            <option>Other</option>
          </select>

          <label>Preview URL (YouTube/Vimeo)</label>
          <input id="previewUrl" placeholder="https://www.youtube.com/watch?v=..." required />

          <label>Full video URL (unlisted link)</label>
          <input id="fullUrl" placeholder="https://www.youtube.com/watch?v=..." required />

          <label>Price (USD)</label>
          <input id="price" type="number" min="1" step="0.01" placeholder="9.99" required />

          <div class="hint">Later we’ll replace this with real file uploads + verified paywall.</div>

          <div class="row" style="margin-top:12px;">
            <button id="publishBtn" class="btn primary" type="submit">Publish post</button>
            <span id="formMsg" class="status"></span>
          </div>
        </form>
      </div>

      <!-- Feed panel -->
      <div class="card panel">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h3 style="margin:0 0 6px;">Browse previews</h3>
            <div class="small">Pulled live from Firestore collection: <code>posts</code></div>
          </div>
          <div style="min-width:220px;">
            <label style="margin-top:0;">Filter by state</label>
            <select id="filterState">
              <option value="">All states</option>
              <option>Wisconsin</option><option>Minnesota</option><option>Michigan</option><option>Illinois</option>
              <option>Iowa</option><option>Indiana</option><option>Ohio</option><option>Missouri</option>
              <option>Texas</option><option>Florida</option><option>California</option><option>New York</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div id="posts" class="posts">
          <div class="status">Loading posts…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      limit,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ PASTE YOUR FIREBASE WEB APP CONFIG HERE (from Firebase Console > Project settings > Your apps)
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME"
    };

    // ✅ PASTE YOUR STRIPE PAYMENT LINK HERE (testing)
    // Example: https://buy.stripe.com/xxxxxx
    const STRIPE_PAYMENT_LINK = "REPLACE_ME";

    const els = {
      firebaseStatus: document.getElementById("firebaseStatus"),
      loginBtn: document.getElementById("loginBtn"),
      logoutBtn: document.getElementById("logoutBtn"),
      authHint: document.getElementById("authHint"),
      postForm: document.getElementById("postForm"),
      publishBtn: document.getElementById("publishBtn"),
      formMsg: document.getElementById("formMsg"),
      title: document.getElementById("title"),
      state: document.getElementById("state"),
      previewUrl: document.getElementById("previewUrl"),
      fullUrl: document.getElementById("fullUrl"),
      price: document.getElementById("price"),
      filterState: document.getElementById("filterState"),
      posts: document.getElementById("posts")
    };

    function setStatusOk(msg){ els.firebaseStatus.textContent = msg; els.firebaseStatus.style.borderColor = "rgba(20,184,166,.35)"; }
    function setStatusBad(msg){ els.firebaseStatus.textContent = msg; els.firebaseStatus.style.borderColor = "rgba(239,68,68,.35)"; }

    function normalizeYouTubeToEmbed(url) {
      try {
        const u = new URL(url);
        // youtu.be/<id>
        if (u.hostname.includes("youtu.be")) {
          const id = u.pathname.replace("/", "");
          return `https://www.youtube.com/embed/${id}`;
        }
        // youtube.com/watch?v=<id>
        if (u.hostname.includes("youtube.com")) {
          const id = u.searchParams.get("v");
          if (id) return `https://www.youtube.com/embed/${id}`;
          // youtube.com/embed/<id> already
          if (u.pathname.startsWith("/embed/")) return url;
        }
      } catch(_) {}
      return url; // fallback (Vimeo etc.)
    }

    function money(n){
      const num = Number(n);
      if (Number.isFinite(num)) return `$${num.toFixed(2)}`;
      return "$—";
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Init
    let app, auth, db, currentUser = null;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      setStatusOk("Connected to Firebase");
    } catch (e) {
      console.error(e);
      setStatusBad("Firebase config missing");
    }

    // Auth UI
    const provider = new GoogleAuthProvider();

    els.loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert("Login failed. If you're on GitHub Pages, add russellberzinski.github.io to Firebase Auth > Authorized domains.");
        console.error(e);
      }
    });

    els.logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        els.loginBtn.style.display = "none";
        els.logoutBtn.style.display = "inline-block";
        els.authHint.style.display = "none";
      } else {
        els.loginBtn.style.display = "inline-block";
        els.logoutBtn.style.display = "none";
      }
    });

    // Create post
    els.postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        els.authHint.style.display = "block";
        return;
      }

      const payload = {
        title: els.title.value.trim(),
        state: els.state.value.trim(),
        previewUrl: els.previewUrl.value.trim(),
        fullUrl: els.fullUrl.value.trim(),
        price: Number(els.price.value),
        creatorUid: currentUser.uid,
        creatorName: currentUser.displayName || "Creator",
        createdAt: serverTimestamp()
      };

      if (!payload.title || !payload.state || !payload.previewUrl || !payload.fullUrl || !Number.isFinite(payload.price)) {
        els.formMsg.textContent = "Please fill all fields.";
        return;
      }

      els.publishBtn.disabled = true;
      els.formMsg.textContent = "Publishing…";

      try {
        await addDoc(collection(db, "posts"), payload);
        els.formMsg.textContent = "✅ Published!";
        els.postForm.reset();
      } catch (err) {
        console.error(err);
        els.formMsg.textContent = "❌ Publish failed (check Firestore rules).";
      } finally {
        els.publishBtn.disabled = false;
        setTimeout(() => (els.formMsg.textContent = ""), 2500);
      }
    });

    // Render feed
    let unsubscribe = null;

    function renderPosts(docs) {
      const filter = els.filterState.value;
      const filtered = filter ? docs.filter(d => (d.data().state || "") === filter) : docs;

      if (filtered.length === 0) {
        els.posts.innerHTML = `<div class="status">No posts yet.</div>`;
        return;
      }

      els.posts.innerHTML = filtered.map((doc) => {
        const d = doc.data();
        const title = escapeHtml(d.title || "Untitled");
        const state = escapeHtml(d.state || "—");
        const price = money(d.price);
        const creator = escapeHtml(d.creatorName || "Creator");
        const embed = normalizeYouTubeToEmbed(d.previewUrl || "");
        const fullUrl = d.fullUrl || "";
        const id = doc.id;

        return `
          <div class="card post">
            <div class="postTop">
              <div>
                <h3>${title}</h3>
                <div class="meta">${state} • by ${creator}</div>
              </div>
              <div class="price">${price}</div>
            </div>

            <div class="video">
              <iframe src="${escapeHtml(embed)}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <div class="actions">
              <button class="btn primary" data-unlock="${escapeHtml(id)}">Unlock premium</button>
              <span class="status">You’ll be redirected to payment.</span>
            </div>

            <input type="hidden" id="full_${escapeHtml(id)}" value="${escapeHtml(fullUrl)}" />
          </div>
        `;
      }).join("");

      // Unlock handlers
      document.querySelectorAll("[data-unlock]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-unlock");
          const full = document.getElementById(`full_${id}`)?.value || "";

          if (!STRIPE_PAYMENT_LINK || STRIPE_PAYMENT_LINK === "REPLACE_ME") {
            alert("Add your Stripe Payment Link URL into STRIPE_PAYMENT_LINK in index.html first.");
            return;
          }

          // Store what to reveal after payment (testing approach)
          localStorage.setItem("reelsecrets_fullUrl", full);
          localStorage.setItem("reelsecrets_postId", id);
          localStorage.setItem("reelsecrets_paidAt", String(Date.now()));

          // Send to Stripe Payment Link
          window.location.href = STRIPE_PAYMENT_LINK;
        });
      });
    }

    function startFeed() {
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(50));
      unsubscribe = onSnapshot(q, (snap) => renderPosts(snap.docs), (err) => {
        console.error(err);
        els.posts.innerHTML = `<div class="toast bad">Could not load posts. Check Firestore rules and that Firestore is enabled.</div>`;
      });
    }

    els.filterState.addEventListener("change", () => {
      // simplest: rerender by pulling current DOM from last snapshot
      // (we keep it easy: just reload page to reapply filter if needed)
      // Better: store last docs in memory.
      window.location.reload();
    });

    startFeed();
  </script>
</body>
</html>
